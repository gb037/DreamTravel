<?php	require_once 'authorise.php';		authorise_user(array('Customers'));		$tripID = $_POST['tripID'];	$bookingID = $_POST['bookingID'];	$noOfTravs = $_POST['noOfTravs'];			//Add $placesLeft back to Trip, depending on $noOfTravs in booking	function updateTripInDB($db) {				// get the data from the front end;		$tripID = $_POST['tripID'];		$noOfTravs = $_POST['noOfTravs'];				$sqlQuery = "UPDATE Trips 					SET placesLeft = placesLeft + :noOfTravs					WHERE tripID = :tripID";					$params = array(								'tripID' => $tripID,								'noOfTravs' => $noOfTravs								);									$result = $db->prepare($sqlQuery);					$result->execute($params);	}		//Find users associated with the booking (based on bookingID). Delete records from groups_users with these user IDs.	function removeGroupUserInDB($db) {				// get the data from the front end		$userID = $_SESSION['user_id'];		$bookingID = $_POST['bookingID'];		$noOfTravs = $_POST['noOfTravs'];			switch ($noOfTravs) {			case "2":				global $user_id_t1;				global $user_id_t2;								// Look up the user ID for Traveller 2 based on the booking ID				$query2 = "SELECT MAX(user_id) AS 'user_id'				FROM bookings_users 				WHERE booking_id = :bookingID";				$params2 = array(								'bookingID' => $bookingID								);								$result2 = $db->prepare($query2);				$result2->execute($params2);				$found = true;				while ($row = $result2->fetch(PDO::FETCH_ASSOC)) 				{             					  $found = false;					  //get the ID found in the database					  $user_id_t2 = $row['user_id'];					  $found = true;					  break;				}				echo 'Traveller 2 ID is ', $user_id_t2, '   ' ;									//delete Traveller 2's record in group_users				$sqlQuery2 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_2 = $db->prepare($sqlQuery2);								//execute the query				$query_2->execute(array($user_id_t2));												$user_id_t1 = $user_id_t2 - 1;								echo 'Traveller 1 ID is ', $user_id_t1, '   ' ;									//delete Traveller 1's record in group_users				$sqlQuery1 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_1 = $db->prepare($sqlQuery1);								//execute the query				$query_1->execute(array($user_id_t1));														return $user_id_t1;				return $user_id_t2;				break;			case "3":				global $user_id_t1;				global $user_id_t2;				global $user_id_t3;								// Look up the user ID for Traveller 3 based on the booking ID				$query2 = "SELECT MAX(user_id) AS 'user_id'				FROM bookings_users 				WHERE booking_id = :bookingID";				$params2 = array(								'bookingID' => $bookingID								);								$result2 = $db->prepare($query2);				$result2->execute($params2);				$found = true;				while ($row = $result2->fetch(PDO::FETCH_ASSOC)) 				{             					  $found = false;					  //get the ID found in the database					  $user_id_t3 = $row['user_id'];					  $found = true;					  break;				}				echo 'Traveller 3 ID is ', $user_id_t3, '   ' ;																	//delete Traveller 3's record in group_users				$sqlQuery3 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_3 = $db->prepare($sqlQuery3);								//execute the query				$query_3->execute(array($user_id_t3));																$user_id_t2 = $user_id_t3 - 1;				$user_id_t1 = $user_id_t2 - 1;								echo 'Traveller 2 ID is ', $user_id_t2, '   ' ;					echo 'Traveller 1 ID is ', $user_id_t1, '   ' ;																	//delete Traveller 2's record in group_users				$sqlQuery2 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_2 = $db->prepare($sqlQuery2);								//execute the query				$query_2->execute(array($user_id_t2));																				//delete Traveller 1's record in group_users				$sqlQuery1 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_1 = $db->prepare($sqlQuery1);								//execute the query				$query_1->execute(array($user_id_t1));																		return $user_id_t1;				return $user_id_t2;				return $user_id_t3;				break;			case "4":				global $user_id_t1;				global $user_id_t2;				global $user_id_t3;				global $user_id_t4;								// Look up the user ID for Traveller 3 based on the booking ID				$query2 = "SELECT MAX(user_id) AS 'user_id'				FROM bookings_users 				WHERE booking_id = :bookingID";				$params2 = array(								'bookingID' => $bookingID								);								$result2 = $db->prepare($query2);				$result2->execute($params2);				$found = true;				while ($row = $result2->fetch(PDO::FETCH_ASSOC)) 				{             					  $found = false;					  //get the ID found in the database					  $user_id_t4 = $row['user_id'];					  $found = true;					  break;				}				echo 'Traveller 4 ID is ', $user_id_t4, '   ' ;																	//delete Traveller 3's record in group_users				$sqlQuery4 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_4 = $db->prepare($sqlQuery4);								//execute the query				$query_4->execute(array($user_id_t4));												$user_id_t3 = $user_id_t4 - 1;				$user_id_t2 = $user_id_t3 - 1;				$user_id_t1 = $user_id_t2 - 1;								echo 'Traveller 3 ID is ', $user_id_t3, '   ' ;					echo 'Traveller 2 ID is ', $user_id_t2, '   ' ;					echo 'Traveller 1 ID is ', $user_id_t1, '   ' ;																	//delete Traveller 3's record in group_users				$sqlQuery3 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_3 = $db->prepare($sqlQuery3);								//execute the query				$query_3->execute(array($user_id_t3));																				//delete Traveller 2's record in group_users				$sqlQuery2 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_2 = $db->prepare($sqlQuery2);								//execute the query				$query_2->execute(array($user_id_t2));																				//delete Traveller 1's record in group_users				$sqlQuery1 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_1 = $db->prepare($sqlQuery1);								//execute the query				$query_1->execute(array($user_id_t1));																		return $user_id_t1;				return $user_id_t2;				return $user_id_t3;				return $user_id_t4;				break;			default:				global $user_id_t1;								// Look up the user ID for Traveller 1 based on the booking ID				$query1 = "SELECT MAX(user_id) AS 'user_id'				FROM bookings_users 				WHERE booking_id = :bookingID";				$params1 = array(								'bookingID' => $bookingID								);								$result1 = $db->prepare($query1);				$result1->execute($params1);				$found = true;				while ($row = $result1->fetch(PDO::FETCH_ASSOC)) 				{             					  $found = false;					  //get the ID found in the database					  $user_id_t1 = $row['user_id'];					  $found = true;					  break;				}				echo 'Traveller 1 ID is ', $user_id_t1, '   ' ;									//delete Traveller 1's record in group_users				$sqlQuery1 = "DELETE FROM groups_users WHERE user_id=?";							//prepare the query				$query_1 = $db->prepare($sqlQuery1);								//execute the query				$query_1->execute(array($user_id_t1));												return $user_id_t1;		}	}				//Disassociate Traveller(s) and Customer from Booking using $booking ID	function removeBookingTravellerInDB($db) {				// get the data from the front end		$bookingID = $_POST['bookingID'];					$sqlQuery = "DELETE FROM bookings_users WHERE booking_id=?";		//prepare the query		$query = $db->prepare($sqlQuery);				//execute the query		$query->execute(array($bookingID));	}			//Remove booking based on $bookingID	function removeBookingInDB($db) {		// get the data from the front end;		$bookingID = $_POST['bookingID'];							$sqlQuery = "DELETE FROM bookings WHERE ID=?";		//prepare the query		$query = $db->prepare($sqlQuery);				//execute the query		$query->execute(array($bookingID));		}		//Remove Traveller data in the database 	function removeTravellerInDB($db, $user_id_t1, $user_id_t2, $user_id_t3, $user_id_t4) {			$noOfTravs = $_POST['noOfTravs'];			switch ($noOfTravs) {			case "2":				//delete traveller 1				$sqlQuery = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query = $db->prepare($sqlQuery);								//execute the query				$query->execute(array($user_id_t1));												//delete traveller 2				$sqlQuery2 = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query2 = $db->prepare($sqlQuery2);								//execute the query				$query2->execute(array($user_id_t2));				// check if the customer was successfully inserted in the database				if ($query2) {					//once the SQL write operation is complete, redirect to a receipt page					header("Location: upcomingBookings.php");					die();				}				else {					//redirect to an error page					header("Location: error.php");					die();				}				break;			case "3":				//delete traveller 1				$sqlQuery = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query = $db->prepare($sqlQuery);								//execute the query				$query->execute(array($user_id_t1));												//delete traveller 2				$sqlQuery2 = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query2 = $db->prepare($sqlQuery2);								//execute the query				$query2->execute(array($user_id_t2));																//delete traveller 3				$sqlQuery3 = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query3 = $db->prepare($sqlQuery3);								//execute the query				$query3->execute(array($user_id_t3));				// check if the customer was successfully inserted in the database				if ($query3) {					//once the SQL write operation is complete, redirect to a receipt page					header("Location: upcomingBookings.php");					die();				}				else {					//redirect to an error page					header("Location: error.php");					die();				}				break;			case "4":				//delete traveller 1				$sqlQuery = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query = $db->prepare($sqlQuery);								//execute the query				$query->execute(array($user_id_t1));												//delete traveller 2				$sqlQuery2 = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query2 = $db->prepare($sqlQuery2);								//execute the query				$query2->execute(array($user_id_t2));																//delete traveller 3				$sqlQuery3 = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query3 = $db->prepare($sqlQuery3);								//execute the query				$query3->execute(array($user_id_t3));												//delete traveller 4				$sqlQuery4 = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query4 = $db->prepare($sqlQuery4);								//execute the query				$query4->execute(array($user_id_t4));				// check if the customer was successfully inserted in the database				if ($query4) {					//once the SQL write operation is complete, redirect to a receipt page					header("Location: upcomingBookings.php");					die();				}				else {					//redirect to an error page					header("Location: error.php");					die();				}				break;			default:				//delete traveller 1				$sqlQuery = "DELETE FROM Users WHERE ID=?";								//prepare the query				$query = $db->prepare($sqlQuery);								//execute the query				$query->execute(array($user_id_t1));				// check if the customer was successfully inserted in the database				if ($query) {					//once the SQL write operation is complete, redirect to a receipt page					header("Location: upcomingBookings.php");					die();				}				else {					//redirect to an error page					header("Location: error.php");					die();				}		}				}		/* Main body */	//connect to the DB	$dsn = 'mysql:host=127.0.0.1;dbname=dream-travel-v05';	$user = 'root';	$password = '';		try {		$db = new PDO($dsn, $user, $password);		$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);	} catch (PDOException $e) {		//           echo 'Connection failed: ' . $e->getMessage();		die('Sorry, database problem');	}						updateTripInDB($db);	removeGroupUserInDB($db);	removeBookingTravellerInDB($db);	removeBookingInDB($db);	removeTravellerInDB($db, $user_id_t1, $user_id_t2, $user_id_t3, $user_id_t4);?>